<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing... - Wik-\cup-pedia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="bg-gray-900 text-white">
    <header class="bg-gray-800 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="{{ url_for('index') }}" class="text-2xl font-serif">Wik-\cup-pedia</a>
        </div>
    </header>
    
    <div class="container mx-auto px-4 py-8">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg max-w-xl mx-auto text-center">
            <h1 class="text-2xl font-semibold mb-6">Synthesizing Article</h1>
            
            <div class="loading-spinner mb-6"></div>
            
            <p class="mb-4">Creating a comprehensive article about <strong>{{ job.title }}</strong> from multiple language editions</p>
            
            <div id="currentStep" class="text-blue-400 mb-4">
                Initializing...
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: {{ job.progress }}%;"></div>
            </div>
            <div class="text-sm text-gray-400 mt-2">
                <span id="progressText">{{ job.progress }}%</span> complete
            </div>
            
            <div class="mt-6 bg-gray-700 p-4 rounded text-left">
                <h3 class="text-lg font-medium mb-2">Process Steps:</h3>
                <ul class="text-sm space-y-2">
                    <li class="step-item" data-progress="10">
                        <span class="step-number">1</span>
                        <span class="step-desc">Retrieving original article</span>
                    </li>
                    <li class="step-item" data-progress="20">
                        <span class="step-number">2</span>
                        <span class="step-desc">Selecting most relevant language editions with AI</span>
                    </li>
                    <li class="step-item" data-progress="30">
                        <span class="step-number">3</span>
                        <span class="step-desc">Collecting content from each language</span>
                    </li>
                    <li class="step-item" data-progress="40">
                        <span class="step-number">4</span>
                        <span class="step-desc">Translating articles (parallel processing)</span>
                    </li>
                    <li class="step-item" data-progress="80">
                        <span class="step-number">5</span>
                        <span class="step-desc">Synthesizing into comprehensive article</span>
                    </li>
                </ul>
            </div>
            
            <p class="text-sm text-gray-300 mt-6">
                This process typically takes 3-7 minutes depending on article length and the number of languages.
            </p>
            
            {% if job.error %}
            <div class="error-message mt-4">
                <p class="text-red-400">Error: {{ job.error }}</p>
                <p class="mt-2">
                    <a href="{{ url_for('index') }}" class="text-blue-400 hover:underline">Return to search</a>
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        // Update progress via AJAX
        function updateProgress() {
            fetch('{{ url_for("api_status", job_id=job.id) }}')
                .then(response => response.json())
                .then(data => {
                    // Update progress bar
                    document.getElementById('progressFill').style.width = data.progress + '%';
                    document.getElementById('progressText').textContent = data.progress;
                    
                    // Update current step
                    updateCurrentStep(data.progress);
                    
                    // If complete, redirect to article page
                    if (data.status === 'completed') {
                        window.location.href = '{{ url_for("article", job_id=job.id) }}';
                    }
                    // If error, show error message
                    else if (data.status === 'error' && !document.querySelector('.error-message')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message mt-4';
                        errorDiv.innerHTML = `
                            <p class="text-red-400">Error: ${data.error}</p>
                            <p class="mt-2">
                                <a href="{{ url_for('index') }}" class="text-blue-400 hover:underline">Return to search</a>
                            </p>
                        `;
                        document.querySelector('.container > div').appendChild(errorDiv);
                    }
                    // Otherwise, continue polling
                    else if (data.status !== 'error') {
                        setTimeout(updateProgress, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    setTimeout(updateProgress, 5000); // Retry after longer delay on error
                });
        }
        
        // Update current step based on progress
        function updateCurrentStep(progress) {
            const steps = document.querySelectorAll('.step-item');
            let currentStep = "Initializing...";
            
            // Mark steps as active/completed based on progress
            steps.forEach(step => {
                const stepProgress = parseInt(step.dataset.progress);
                
                if (progress >= stepProgress) {
                    step.classList.add('active');
                    currentStep = step.querySelector('.step-desc').textContent;
                } else {
                    step.classList.remove('active');
                }
            });
            
            document.getElementById('currentStep').textContent = "Current step: " + currentStep;
        }
        
        // Initialize steps styling
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentStep({{ job.progress }});
        });
        
        // Start polling immediately
        updateProgress();
    </script>
    
    <style>
        .step-item {
            display: flex;
            align-items: center;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .step-item.active {
            opacity: 1;
        }
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: #374151;
            border-radius: 50%;
            margin-right: 10px;
        }
        .step-item.active .step-number {
            background-color: #3b82f6;
        }
    </style>
</body>
</html>